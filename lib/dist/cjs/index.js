var e=require("react"),t=require("react/jsx-runtime");function o(e,t,o,n){Object.defineProperty(e,t,{get:o,set:n,enumerable:!0,configurable:!0})}o(module.exports,"Connect",(()=>c)),o(module.exports,"ConnectProvider",(()=>g)),o(module.exports,"ConnectLines",(()=>p));const n=(0,e.createContext)({elements:[],dispatch:()=>null});function r(){if(!(0,e.useContext)(n))throw new Error("Missing context value");return(0,e.useContext)(n)}function i(e,t){const{type:o,id:n,element:r,connectWith:i}=t,s=e?.elements?.some((e=>e.id===n)),c={id:n,element:r,connectWith:i||[]};if("add"===o&&r){if(!s)return{...e,elements:[...e.elements,c]};if(s){const t=[...e.elements].map((e=>e.id===n?c:e));return{...e,elements:t}}return e}return"remove"===o?{...e,elements:e.elements.map((e=>({...e,connectWith:e.connectWith?.filter((e=>e.id!==n))}))).filter((e=>e.id!==n))}:e}function s(o){const{children:r}=o,[s,c]=(0,e.useReducer)(i,{elements:[],dispatch:()=>null}),d=(0,e.useMemo)((()=>({elements:s.elements,dispatch:c})),[s]);return(0,t.jsx)(n.Provider,{value:d,children:r})}function c(t){const{children:o,id:n,connectWith:i}=t,{dispatch:s}=r(),c=(0,e.useRef)(),d=(0,e.useCallback)((()=>{s({type:"add",id:n,connectWith:i,element:c.current})}),[i,s,n]),l=(0,e.useMemo)((()=>{const{props:t}=o;return(0,e.cloneElement)(o,{...t,ref:e=>{c.current=e,"function"==typeof o&&t.ref(e)}})}),[o]);return(0,e.useEffect)((()=>{d()}),[t,d,c]),(0,e.useEffect)((()=>()=>{s({type:"remove",id:n})}),[s,n]),l}const d=e=>{const{paths:t,edge:o}=e;return`M ${t.map(((e,t)=>1===t&&"step"===o?`${e.x} ${e.y}`:1===t&&"bezier"===o?`C ${e.x} ${e.y}`:`${e.x} ${e.y}`)).join(" ")}`};function l(e){return e.element?e.element:document.querySelector(`#${e.id}`)}const m=[];function u(e){const{elements:t}=e;return t.filter((e=>(e?.connectWith||m).length>0)).map((e=>{const{connectWith:o}=e,n=t.filter((e=>o?.map((e=>e.id)).includes(e.id))).map((e=>({rect:l(e)?.getBoundingClientRect(),color:o?.find((t=>t.id===e.id))?.color||"#000000",edge:o?.find((t=>t.id===e.id))?.edge||"bezier",stroke:o?.find((t=>t.id===e.id))?.stroke||"solid",hasArrows:Boolean(o?.find((t=>t.id===e.id))?.hasArrows)})));if(0!==n.length)return{from:{rect:l(e)?.getBoundingClientRect()},to:n}})).filter(Boolean)}function a(e){const{from:t,to:o}=e,n=t?.rect,r=o?.rect;if(!n||!r)return;const i=function(e){const{from:t,to:o}=e,n=t.left-40<o.right&&t.right+o.width>o.right-40,r=t.bottom<o.top&&n,i=t.top>o.bottom&&n,s=t.left>o.right,c=t.right<o.left;return r?"bottom-to-top":i?"top-to-bottom":s?"right-to-left":c?"left-to-right":void 0}({from:n,to:r});switch(i){case"bottom-to-top":return[{x:n?.left+n.width/2,y:n?.bottom},{x:n?.left+n.width/2,y:n.bottom-(n.bottom-r.top)/2},{x:r?.left+r.width/2,y:n.bottom-(n.bottom-r.top)/2},{x:r?.left+r.width/2,y:r.top-9}];case"top-to-bottom":return[{x:n?.left+n.width/2,y:n?.top},{x:n?.left+n.width/2,y:n.top-(n.top-r.bottom)/2},{x:r?.left+r.width/2,y:n.top-(n.top-r.bottom)/2},{x:r?.left+r.width/2,y:r.bottom+9}];case"right-to-left":return[{x:n?.left,y:n?.bottom-n.height/2},{x:(r.right+n.left)/2,y:n?.bottom-n.height/2},{x:(r.right+n.left)/2,y:r.top+r.height/2},{x:r.right+9,y:r.top+r.height/2}];case"left-to-right":return[{x:n?.right,y:n?.bottom-n.height/2},{x:(r.left+n.right)/2,y:n?.bottom-n.height/2},{x:(r.left+n.right)/2,y:r.top+r.height/2},{x:r.left-9,y:r.top+r.height/2}];default:return[]}}const h={position:"fixed",top:"0",left:"0",right:"0",bottom:"0",pointerEvents:"none",width:"100%",height:"100%"},f=[];function p(o){const[n,r]=(0,e.useState)(f),[i,s]=(0,e.useState)(!1),{elements:c}=o,m=(0,e.useRef)(),p=(0,e.useMemo)((()=>[...new Set([...c.map((e=>e.connectWith?.map((e=>e?.color)))).flat(),"#000000"])].filter(Boolean)),[c]),v=(0,e.useCallback)((()=>{m.current&&window.cancelAnimationFrame(m.current),m.current=window.requestAnimationFrame((()=>{const e=u({elements:c}).map((e=>{const{from:t,to:o}=e||{},n=o?.map((e=>{const o=a({from:t,to:e});if(!o)return;const n=d({paths:o,edge:e?.edge});return/\d/.test(n)?{d:n,...e}:void 0}));return n})).filter(Boolean).flat().filter((e=>Boolean(e)));r(e)}))}),[c]),g=(0,e.useCallback)((()=>{s(!0)}),[]),x=(0,e.useCallback)((()=>{s(!1)}),[]),w=(0,e.useCallback)((()=>{i&&v()}),[v,i]);(0,e.useEffect)((()=>{v()}),[v]),(0,e.useEffect)((()=>(window.addEventListener("resize",v,{passive:!0}),window.addEventListener("scroll",v,{passive:!0}),()=>{window.removeEventListener("resize",v),window.removeEventListener("scroll",v)})),[v]);const b=(0,e.useMemo)((()=>new ResizeObserver(v)),[v]);return(0,e.useEffect)((()=>(c.forEach((e=>{const t=l(e);t?.addEventListener("mousedown",g,{passive:!0}),t?.addEventListener("mouseup",x,{passive:!0}),t?.addEventListener("mousemove",w,{passive:!0}),t?.addEventListener("touchstart",g,{passive:!0}),t?.addEventListener("touchend",x,{passive:!0}),t?.addEventListener("touchmove",w,{passive:!0}),t&&b.observe(t)})),()=>{c.forEach((e=>{const t=l(e);t?.removeEventListener("mousedown",g),t?.removeEventListener("mouseup",x),t?.removeEventListener("mousemove",w),t?.removeEventListener("touchstart",g),t?.removeEventListener("touchend",x),t?.removeEventListener("touchmove",w),t&&(b.disconnect(),b.unobserve(t))}))})),[c,v,g,x,w,b]),(0,e.useMemo)((()=>(0,t.jsxs)("svg",{style:h,children:[p?.map((e=>(0,t.jsxs)("defs",{children:[(0,t.jsx)("marker",{id:`triangle-${e}`,markerHeight:"5",markerUnits:"strokeWidth",markerWidth:"5",orient:"auto",refX:"1",refY:"5",viewBox:"0 0 10 10",children:(0,t.jsx)("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:e})}),(0,t.jsx)("marker",{id:`line-${e}`,markerHeight:"5",markerUnits:"strokeWidth",markerWidth:"10",orient:"auto",refX:"0",refY:"5",viewBox:"0 0 10 10",children:(0,t.jsx)("path",{d:"M 0 5 L 10 5",stroke:e,strokeWidth:"2",fill:"none"})})]},e))),n?.map((e=>(0,t.jsx)("path",{id:"p1",d:e?.d,fill:"none",stroke:e?.color,strokeWidth:"2",strokeDasharray:"dashed"===e?.stroke?4:0,strokeLinejoin:"round",markerEnd:`url(#${e?.hasArrows?"triangle":"line"}-${e?.color})`},e?.d)))]})),[p,n])}function v(){const{elements:e}=r();return(0,t.jsx)(p,{elements:e})}function g(e){const{children:o}=e;return(0,t.jsxs)(s,{children:[o,(0,t.jsx)(v,{})]})}
//# sourceMappingURL=index.js.map
